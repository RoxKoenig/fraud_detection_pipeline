name: MLOps Pipeline for Fraud Detection with Database Connection

on:
  schedule:
    - cron: '0 0 1 * *'  # Run on the 1st of every month
  workflow_dispatch:  # Allow manual triggering

jobs:
  pipeline:
    name: Fraud Detection MLOps Pipeline with Database Connection
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.3'

      # Step 3: Install dependencies
      - name: Install Python dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install psycopg2

      # Step 4: Set up Docker and Docker Compose
      - name: Install Docker Compose (if missing)
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      # Step 5: Build and Start Services with Docker Compose
      - name: Build and Start Docker Services
        run: |
          docker-compose up --build -d
          echo "Waiting for services to be ready..."
          for i in {1..30}; do
            curl --silent --fail http://localhost:5001 || true
            if [ $? -eq 0 ]; then
              echo "MLflow server is ready."
              exit 0
            fi
            echo "MLflow server not ready yet. Retrying in 5 seconds..."
            sleep 5
          done
          echo "MLflow server failed to start."
          docker-compose logs
          exit 1

      # Step 6: Load Database Backup
      - name: Load Database Backup
        env:
          DB_USER: admin
          DB_PASSWORD: password
          DB_NAME: fraud_detection_db
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          echo "Loading database backup..."
          docker exec -i fraud_detection_db psql -U $DB_USER -d $DB_NAME < fraud_detection_db_backup.sql

      # Step 7: Verify Database Connection
      - name: Test Database Connection
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python database.py

      # Step 8: Generate Monthly Data
      - name: Generate Monthly Data
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python generate_monthly_data.py --month 1 --output_path output.csv

      # Step 9: Detect Data Drift
      - name: Detect Data Drift
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python data_drift.py

      # Step 10: Retrain Model
      - name: Retrain Model
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python retrain.py

      # Step 11: Deploy the Model
      - name: Deploy Model
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python deploy_model.py

      # Step 12: Run Main Pipeline Script
      - name: Run Main Pipeline Script
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python main.py

      # Step 13: Notify the Team
      - name: Notify Team on Success
        if: success()
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: your-slack-channel-id
          text: "âœ… MLOps pipeline completed successfully with database integration and backup loaded!"
          bot-token: ${{ secrets.SLACK_BOT_TOKEN }}

      # Step 14: Cleanup Docker Containers
      - name: Clean up Docker containers
        run: |
          docker-compose down

