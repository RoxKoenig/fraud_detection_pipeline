---
name: MLOps Pipeline for Fraud Detection with Database Connection

on:
  schedule:
    - cron: '0 0 1 * *'  # Run on the 1st of every month
  workflow_dispatch:  # Allow manual triggering

jobs:
  pipeline:
    name: Fraud Detection MLOps Pipeline with Database Connection
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.3'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
          pip install psycopg2  # Ensure psycopg2 is installed

      # Step 4: Start Database using Docker
      - name: Start Dockerized Database
        run: |
          docker pull postgres:latest
          docker run -d --name fraud_db -p 5432:5432 \
            -e POSTGRES_DB=fraud_detection_db \
            -e POSTGRES_USER=admin \
            -e POSTGRES_PASSWORD=password \
            postgres:latest
          echo "Waiting for the database to be ready..."
          sleep 10

      # Step 5: Verify Database Connection
      - name: Test Database Connection
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          python - <<EOF
          import psycopg2
          import os

          db_config = {
              'dbname': os.getenv('DB_NAME'),
              'user': os.getenv('DB_USER'),
              'password': os.getenv('DB_PASSWORD'),
              'host': os.getenv('DB_HOST'),
              'port': os.getenv('DB_PORT'),
          }

          try:
              conn = psycopg2.connect(**db_config)
              print('Database connection successful!')
              conn.close()
          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          EOF

      # Step 6: Generate monthly data
      - name: Generate Monthly Data
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python generate_monthly_data.py

      # Step 7: Detect data drift
      - name: Detect Data Drift
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python data_drift.py

      # Step 8: Retrain model
      - name: Retrain Model
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python retrain.py

      # Step 9: Deploy the model
      - name: Deploy Model
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python deploy_model.py

      # Step 10: Run Main Script
      - name: Run Main Pipeline Script
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python main.py

      # Step 11: Start the application
      - name: Start Application
        env:
          DB_NAME: fraud_detection_db
          DB_USER: admin
          DB_PASSWORD: password
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          source .venv/bin/activate
          python app.py

      # Step 12: Notify the team
      - name: Notify Team
        if: success()
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: your-slack-channel-id
          text: "MLOps pipeline completed successfully with database integration!"
          bot-token: ${{ secrets.SLACK_BOT_TOKEN }}

      # Step 13: Cleanup Docker
      - name: Clean up Docker containers
        run: |
          docker stop fraud_db
          docker rm fraud_db

